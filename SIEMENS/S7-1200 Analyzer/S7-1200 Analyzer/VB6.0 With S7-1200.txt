Option Explicit
Dim TCP_Control  As Byte
Dim ID1, ID2 As Byte
Dim count_seq As Byte

Private Sub btn_Connect_Click(Index As Integer)
TCP_Control = 1
Winsock1.Close
Winsock1.RemoteHost = Text1.Text
Winsock1.RemotePort = 102
Winsock1.Connect
End Sub

Private Sub cr_send()
Text2.Text = "030000231ee00000000600c1020600c20f53494d415449432d524f4f542d4553c0010a"
send_data   ' Send packet CR
End Sub


Private Sub setup_com()
Text2.Text = "030000f202f080720100e331000004ca0000000100000120360000011d00040000000000a1000000d3821f0000a3816900151553657276657253657373696f6e5f31433943333839a38221001538302e302e302e303a30496e74656c2852292050524f2f31303030204d54204e6574776f726b20436f6e6e656374696f6e2e54435049502e31a38228001500a38229001500a3822a00151757494e2d344331324c4630424a47365f31323230383332a3822b000401a3822c001201c9c389a3822d001500a1000000d3817f0000a38169001515537562736372697074696f6e436f6e7461696e6572a2a20000000072010000"
send_data   'Get ID1, ID2
End Sub

Private Sub send_data()

Dim gui() As Byte
Dim i, j As Integer
Dim strHex As String
Dim Hexdata As Byte

If Len(Text2.Text) Mod 2 = 0 Then

ReDim gui(Len(Text2.Text) / 2 - 1)
i = 1
j = 0
    Do Until i > Len(Text2.Text)
    strHex = UCase(Mid(Text2.Text, i, 2))
    Hexdata = Val("&H" & strHex)
    gui(j) = Hexdata
    i = i + 2
    j = j + 1
    Loop
 
Winsock1.SendData gui
End If

End Sub

Private Sub send_data1()

Dim gui() As Byte
Dim i, j As Integer
Dim strHex As String
Dim Hexdata As Byte

If Len(Text2.Text) Mod 2 = 0 Then

ReDim gui(Len(Text2.Text) / 2 - 1)
i = 1
j = 0
    Do Until i > Len(Text2.Text)
    strHex = UCase(Mid(Text2.Text, i, 2))
    Hexdata = Val("&H" & strHex)
    gui(j) = Hexdata
    i = i + 2
    j = j + 1
    Loop


If gui(14) = &H5 And gui(15) = &H42 And gui(24) = &H34 Then
gui(23) = &H80 + ID1
    If count_seq < 2 Then
    gui(28) = gui(23)
    End If
    
End If

If gui(14) = &H4 And gui(15) = &HCA And gui(24) = &H34 Then
gui(23) = &H80 + ID1
gui(28) = &H80 + ID2
End If

If gui(14) = &H4 And gui(15) = &HCA And gui(24) = &H36 Then
gui(23) = &H80 + ID1
End If

If gui(14) = &H4 And gui(15) = &HF2 And gui(24) = &H36 Then
gui(23) = &H80 + ID1
End If

If gui(14) = &H4 And gui(15) = &HF2 And gui(24) = &H34 Then
gui(23) = &H80 + ID1
End If

If gui(14) = &H4 And gui(15) = &HD4 Then
gui(23) = &H80 + ID1
End If

If gui(14) = &H5 And gui(15) = &H24 Then
gui(23) = &H80 + ID1
End If

If gui(14) = &H4 And gui(15) = &HBB Then
gui(23) = &H80 + ID1
End If


gui(19) = count_seq
count_seq = count_seq + 1

Winsock1.SendData gui
End If

End Sub




Private Sub btn_Off_Click(Index As Integer)

Text2.Text = "0300003d02f0807202002e31000004d4000000510000038c341000007100000004e88969001200000000896a001300896b000400000000000072020000"
send_data1   ' Delete 113
Text2.Text = "0300003d02f0807202002e31000004d4000000530000038c341000007200000004e88969001200000000896a001300896b000400000000000072020000"
send_data1    ' Delete 114

End Sub

Private Sub btn_On_Click(Index As Integer)

Text2.Text = "0300014e02f0807202013f31000004ca00000031000003e4360000000700040000000000a17fffc00a95142000a3816900150d546973466f7263654a6f625f35a39505001400816b402832048c100400057414060601018c110400057413060601018c120400057412060601018c130400057411060601018c140400059402060601018c15040005740f060601018c16040005740e060601018c17040005740d060601018c18040005740c060601018c19040005740b060601018c1a040005740a060601018c1b0400057409060601018c1c0400059401060601018c1d0400057407060601018c1e0400057406060601018c1f0400057405060601018c200400057404060601018c210400057403060601018c220400057402060601018c230400057401060601018c24040005940006060101a395060014000b10040000057c31ed393100a20000000072020000"
send_data1  'Creat 113 20 OUT
Text2.Text = "0300010c02f080720200fd31000004ca000000320000038c34000003b700040000000000a17fffc00b87690000a38169001517537562736372697074696f6e5f466f7263654a6f625f35a3883a000201a3876a00030000a3876b000900a38810000201a38811000101a38818200415888084800000038880c88001080781808080710095008880c88001070781808080710095048880c8800106078180808071009507a38819000400a3881b000200a3881c000200a3881d0007ffffa3881e0003ffffa17fffc00c95180000a3816900151d546973537562736372697074696f6e5265665f466f7263654a6f625f35a3876d000201a39517000200a4950910000071a2a20000000072020000"
send_data1   'Creat 114, 115
Text2.Text = "0300005902f0807202004a3100000542000000330000038c3400000000020800818080807101947f008180808073019517010001010200020100000004e88969001200000000896a001300896b000400000000000072020000"
send_data1   ' Set MultiVar 113, 115

End Sub

Private Sub btn_Run_Click(Index As Integer)
Dim session_id1 As Byte
session_id1 = &H80 + ID1

Text2.Text = "0300004302f0807202003431000004f200000044000003" & LCase(Right$("0" & Hex(session_id1), 2)) & "3400000034019077000803000004e88969001200000000896a001300896b00040000000000000072020000"
send_data
End Sub


Private Sub btn_Send1_Click(Index As Integer)
send_data1
End Sub

Private Sub btn_Send2_Click(Index As Integer)
Text2.Text = "0300008f02f080720200803100000542000000020000038c340000038c010182320100170000013a823b00048200823c00048140823d00048480c040823e00048480c040823f001500824000151a313b36455337203231342d31414533302d305842303b56322e328241000300030000000004e88969001200000000896a001300896b000400000000000072020000"
send_data1  'Ack PLC Type
Text2.Text = "030000af02f080720200a031000004ca000000060000038c34000003b700040000000000a17fffc00387690000a3816900151c53504c5f506c6350726f6772616d5f4368616e6765436f756e746572a3883a000201a3876a00030000a3876b000900a38810000201a38811000101a38818200409888084800000018880d4800101010300932fa38819000400a3881b000200a3881c000200a3881d0007ffffa3881e0003ffffa20000000072020000"
send_data1  'Creat 106
Text2.Text = "030000a002f0807202009131000004ca000000090000038c34000003b700040000000000a17fffc00487690000a38169001517537562736372697074696f6e5f32313437343637323638a3883a000203a3876a00030000a3876b000900a38810000201a38811000101a3881820040388808480000000a3881900048704a3881b000200a3881c000200a3881d0007ffffa3881e0003ffffa20000000072020000"
send_data1  'Creat 107
Text2.Text = "030000d602f080720200c731000004ca0000000c0000038c34000003b700040000000000a17fffc00587690000a38169001517537562736372697074696f6e5f32313437343637323639a3883a000202a3876a00030000a3876b000900a38810000202a38811000101a3881820040388808480000000a38819000400a3881b000200a3881c000200a3881d0007ffffa3881e0003ffffa17fffc00694660000a38169001500a3876d000203a3946310030a0000000000000000000000000000000000000000a4946400000008a2a20000000072020000"
send_data1   'Creat 108, 109
Text2.Text = "030000ac02f0807202009d31000004ca0000000f0000038c34000003b700040000000000a17fffc00787690000a38169001517537562736372697074696f6e5f32313437343637323731a3883a000201a3876a00030000a3876b000900a38810000201a38811000101a3881820040a888084800000018880d4800202303400913d9b1ea38819000400a3881b000200a3881c000200a3881d0007ffffa3881e0003ffffa20000000072020000"
send_data1  'Creat 110
Text2.Text = "030000b802f080720200a931000004ca000000110000038c34000003b700040000000000a17fffc00887690000a381690015254d61726b4a6f625f537562736372697074696f6e5f4d6f644368616e6765436f756e746572a3883a000201a3876a00030000a3876b000900a38810000201a38811000101a38818200409888084800000018880d4800103010b009c2ba38819000400a3881b000200a3881c000200a3881d0007ffffa3881e0003ffffa20000000072020000"
send_data1  'Creat 111
Text2.Text = "030000a702f0807202009831000004ca000000120000038c34000003b700040000000000a17fffc00987690000a3816900151f4d61726b4a6f625f537562736372697074696f6e5f4a6f62456e61626c6564a3883a000201a3876a00030000a3876b000900a38810000201a38811000101a3881820040388808480000000a38819000400a3881b000200a3881c000200a3881d0007ffffa3881e0003ffffa20000000072020000"
send_data1  'Creat 112
Text2.Text = "0300006202f0807202005331000005420000002e0000038c341000006b010188180120040f888088800000028880d08001050032009c758880d0800104003400913d00000004e88969001200000000896a001300896b000400000000000072020000"
send_data1  'Set MultiVar 107
End Sub

Private Sub btn_Stop_Click(Index As Integer)
Dim session_id1 As Byte
session_id1 = &H80 + ID1

Text2.Text = "0300004302f0807202003431000004f20000003f000003" & LCase(Right$("0" & Hex(session_id1), 2)) & "3400000034019077000801000004e88969001200000000896a001300896b00040000000000000072020000"
 
send_data
End Sub

Private Sub Form_Load()
Winsock1.Close
Winsock1.Bind 2000
Timer1.Enabled = True
Timer2.Enabled = False
End Sub

Private Sub Timer1_Timer()

If Mid(Text4.Text, 11, 2) = "D0" Then
 setup_com
 Timer1.Enabled = False
 Timer2.Enabled = True
End If

End Sub

Private Sub Timer2_Timer()

If Mid(Text4.Text, 47, 2) = "87" Then
ID1 = Val("&H" & Mid(Text4.Text, 49, 2))
ID2 = Val("&H" & Mid(Text4.Text, 53, 2))
Timer2.Enabled = False
Label2.Caption = "CODE: " & Chr("&H" & Mid(Text4.Text, 173, 2)) & Chr("&H" & Mid(Text4.Text, 175, 2)) & Chr("&H" & Mid(Text4.Text, 177, 2)) & Chr("&H" & Mid(Text4.Text, 179, 2)) & Chr("&H" & Mid(Text4.Text, 181, 2)) & Chr("&H" & Mid(Text4.Text, 183, 2)) & Chr("&H" & Mid(Text4.Text, 185, 2)) & Chr("&H" & Mid(Text4.Text, 187, 2)) & Chr("&H" & Mid(Text4.Text, 189, 2)) & Chr("&H" & Mid(Text4.Text, 191, 2)) & Chr("&H" & Mid(Text4.Text, 193, 2)) & Chr("&H" & Mid(Text4.Text, 195, 2)) & Chr("&H" & Mid(Text4.Text, 197, 2)) & Chr("&H" & Mid(Text4.Text, 199, 2)) & Chr("&H" & Mid(Text4.Text, 201, 2)) & Chr("&H" & Mid(Text4.Text, 203, 2)) & Chr("&H" & Mid(Text4.Text, 205, 2)) & Chr("&H" & Mid(Text4.Text, 207, 2)) & Chr("&H" & Mid(Text4.Text, 209, 2)) & Chr("&H" & Mid(Text4.Text, 211, 2)) & Chr("&H" & Mid(Text4.Text, 213, 2)) & Chr("&H" & Mid(Text4.Text, 215, 2)) & Chr("&H" & Mid(Text4.Text, 217, 2)) & Chr("&H" & Mid(Text4.Text, 219, 2)) & Chr("&H" & Mid(Text4.Text, 221, 2))
End If

End Sub

Private Sub Winsock1_Connect()

If TCP_Control = 1 Then
cr_send
End If

If TCP_Control = 2 Then
Text2.Text = "0300001611e00000002e00c1020100c2020301c00109"
send_data
Text2.Text = "0300001902f08032010000ffff00080000f000000300030750"
send_data
Text2.Text = "0300002902f080320100000005000e000a0501120a1002000600008200000000040030ffffffffffff"
send_data
TCP_Control = 3
End If

End Sub

Private Sub Winsock1_DataArrival(ByVal bytesTotal As Long)

Text4.Text = ""
Text3.Text = ""
Dim sData As Byte
Dim i As Integer
Text3.Text = Text3.Text + ":"

For i = 0 To bytesTotal - 1
Winsock1.GetData sData, vbByte
Text4.Text = Text4.Text & Right$("0" & Hex(sData), 2)
Text3.Text = Text3.Text & Right$("0" & Hex(sData), 2) & " "
Next

Text3.Text = Text3.Text & vbCrLf

End Sub

Private Sub Winsock1_Error(ByVal Number As Integer, Description As String, ByVal Scode As Long, ByVal Source As String, ByVal HelpFile As String, ByVal HelpContext As Long, CancelDisplay As Boolean)
MsgBox Description
End Sub
